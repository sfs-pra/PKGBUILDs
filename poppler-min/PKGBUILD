# Contributor: Jan de Groot <jgc@archlinux.org>
# Maintainer: Florian Bruhin (The-Compiler) <archlinux.org@the-compiler.org>
# vim: set ts=2 sts=2 et ft=sh tw=79:
pkgbase=poppler
#pkgname='poppler-minimal'
pkgname=('poppler-min' 'poppler-glib-min' )
#'poppler-qt5' 'poppler-qt6')
#pkgver=0.54.0
#pkgver=0.64.0
#pkgver=0.33.0
pkgver=23.05.0
pkgver=24.08.0

pkgrel=3
arch=(i686 x86_64)
license=('GPL')
#makedepends=('icu')
#makedepends=('boost')
makedepends=('poppler-data' 'glib2-devel')
options=('!libtool' '!emptydirs')
pkgdesc="PDF rendering library based on xpdf 3.0 (minimal version)"
depends=('fontconfig' 'gcc-libs')
conflicts=("poppler" "poppler-glib")
provides=("poppler" "poppler-glib")
url="http://poppler.freedesktop.org/"
source=(http://poppler.freedesktop.org/poppler-${pkgver}.tar.xz)
sha1sums=('SKIP')
#56c195f2c5e56fa017d32c0507a31b226f48bedb')

buildX() {
  cd "${srcdir}/poppler-${pkgver}"
  autoreconf -fi
  ./configure \
      --prefix=/usr \
      --sysconfdir=/etc \
      --localstatedir=/var \
      --disable-static \
      --enable-libopenjpeg=none \
--enable-poppler-glib \
--disable-libnss
  make
}

prepare() {
  mkdir build
}

build() {
  cd build
  cmake ../${pkgbase}-${pkgver} \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX:PATH=/usr \
    -DCMAKE_INSTALL_LIBDIR=/usr/lib \
    -DENABLE_UNSTABLE_API_ABI_HEADERS=ON \
    -DENABLE_GTK_DOC=OFF \
	-DBUILD_GTK_TESTS=OFF \
	-DENABLE_QT5=OFF \
	-DENABLE_QT6=OFF \
	-DENABLE_BOOST=OFF \
	-DENABLE_LIBOPENJPEG=unmaintained \
	-DENABLE_NSS3=OFF \
	-DENABLE_GOBJECT_INTROSPECTION=OFF \
	-DENABLE_BOOST=OFF \
	-DENABLE_LCMS=OFF \
	
	make
}


Xpackage() {
  cd "${srcdir}/poppler-${pkgver}"
  make DESTDIR="${pkgdir}" install
}
package_poppler-min() {
  pkgdesc="PDF rendering library based on xpdf 3.0"
#  depends=('libjpeg' 'gcc-libs' 'cairo' 'fontconfig' 'openjpeg2' 'lcms2' 'nss' 'curl')
  depends=('libjpeg' 'gcc-libs' 'cairo' 'fontconfig'  'curl')
  optdepends=('poppler-data: highly recommended encoding data to display PDF documents with certain encodings and characters')
#  provides=('libpoppler.so' 'libpoppler-cpp.so')
  provides=('libpoppler.so' 'libpoppler-cpp.so' 'poppler')
#  conflicts=("poppler-qt3<${pkgver}" "poppler-qt4<${pkgver}")

  cd build
  make DESTDIR="${pkgdir}" install

  # cleanup for splitted build
  rm -vrf "${pkgdir}"/usr/include/poppler/{glib,qt5,qt6}
  rm -vf "${pkgdir}"//usr/lib/libpoppler-{glib,qt5,qt6}.*
  rm -vf "${pkgdir}"/usr/lib/pkgconfig/poppler-{glib,qt5,qt6}.pc
  rm -vrf "${pkgdir}"/usr/{lib,share}/gir*
  rm -vrf "${pkgdir}"/usr/share/gtk-doc
}

package_poppler-glib-min() {
  pkgdesc="Poppler glib bindings"
  depends=("poppler-min=${pkgver}" 'glib2')
  provides=('libpoppler-glib.so' 'poppler-glib')

  cd build

  make -C glib DESTDIR="${pkgdir}" install
  install -m755 -d "${pkgdir}/usr/lib/pkgconfig"
  install -m644 poppler-glib.pc "${pkgdir}/usr/lib/pkgconfig/"
  rm -vf "${pkgdir}"/usr/lib/libpoppler.*
  rm -vf "${pkgdir}/usr/bin/poppler-glib-demo"
}

